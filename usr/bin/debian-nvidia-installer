#!/usr/bin/env bash

# debian-nvidia-installer - NVIDIA Driver Installer for Debian (TUI)
# Copyright (C) 2025 Leonardo Amaral
#
# This file is part of debian-nvidia-installer.
#
# debian-nvidia-installer is free software: you can redistribute it and/or
# modify it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# debian-nvidia-installer is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with debian-nvidia-installer. If not, see <https://www.gnu.org/licenses/gpl-3.0.html>.

declare -g SCRIPT_VERSION="0.6.13-beta"

# Variáveis globais
declare -g SCRIPT_DIR
declare -g LOG_DIR="/var/log/debian-nvidia-installer"

# Detecta se está em modo desenvolvimento ou produção
if [[ -n "$DEVENV" ]]; then
    echo "——— DEVELOPMENT MODE ———"
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../lib/debian-nvidia-installer" && pwd -P)"
else
    SCRIPT_DIR="/usr/lib/debian-nvidia-installer"
fi

# Importação dos módulos
for file in "$SCRIPT_DIR"/translate/*.sh; do source "$file"; done
for file in "$SCRIPT_DIR"/*.sh; do source "$file"; done
for file in "$SCRIPT_DIR"/tui/*.sh; do source "$file"; done

# Limpeza / Encerramento
script::exit() {
    local exit_msg
    exit_msg="$(tr::t "default.script.exit")"
    log::info "${1:-$exit_msg}"
    echo "$(tr::t_args "script::exit.informlogpath" "$LOG_DIR/debian-nvidia-installer.log")"
    log::input _ "$(tr::t "default.script.pause")"
    exit "${2:-0}"
}

tr::add "pt_BR" "script::exit.informlogpath" "O resumo da última execução do script está disponível em: %1"
tr::add "en_US" "script::exit.informlogpath" "The summary of the last script execution is available at: %1"

script::requirements() {
    # Garante que o script só seja executado com privilégios root
    if ! utils::check_sudo; then
        log::warn "$(tr::t "default.script.rootaccess.required")"
        utils::force_sudo "$@" # Reexecuta o script
        script::exit "" 1
    fi

    # Verifica e instala pacotes obrigatórios para execução do script
    log::info "$(tr::t "script::requirements.verifying")"
    if installer::install_package "dialog"; then
        log::info "$(tr::t "script::requirements.success")"
    else
        log::critical "$(tr::t "script::requirements.failure")"
        script::exit "" 1
    fi
}

tr::add "pt_BR" "script::requirements.verifying" "Verificando dependências do script..."
tr::add "pt_BR" "script::requirements.success" "Dependências verificadas com sucesso."
tr::add "pt_BR" "script::requirements.failure" "Falha ao verificar dependências."

tr::add "en_US" "script::requirements.verifying" "Verifying script dependencies..."
tr::add "en_US" "script::requirements.success" "Dependencies verified successfully."
tr::add "en_US" "script::requirements.failure" "Failed to verify dependencies."

# Configura arquivos de logging
log::setup_logger "$LOG_DIR" "debian-nvidia-installer.log"

# Define o idioma do script com base no sistema
tr::detect_language

tr::add "pt_BR" "default.script.welcome" "\
Bem-vindo ao Debian NVIDIA Installer!

Este instalador é distribuído sob a licença GPLv3.

Repositório do projeto:
https://github.com/devleonardoamaral/debian-nvidia-installer

----------------------

"

tr::add "en_US" "default.script.welcome" "\
Welcome to the Debian NVIDIA Installer!

This installer is released under the GPLv3 license.

Project repository:
https://github.com/devleonardoamaral/debian-nvidia-installer

----------------------

"

echo -e "$(tr::t "default.script.welcome")"
log::info "Version $SCRIPT_VERSION"

# Verifica requisitos do script
script::requirements "$@"

# Inicia o Dialog de navegação
tui::navigate::main
ret=$?
script::exit "" "$ret"
